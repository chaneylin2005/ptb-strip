<script>
        // Khai báo các biến DOM và hằng số
        const designView = document.getElementById('design-view');
        const libraryView = document.getElementById('library-view');
        const mainTitle = document.getElementById('main-title');

        const canvas = document.getElementById('photoStripCanvas');
        const ctx = canvas.getContext('2d');
        const webcamFeed = document.getElementById('webcamFeed');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const exportFinalImageBtn = document.getElementById('exportFinalImageBtn');
        const frameColorInput = document.getElementById('frameColor');
        const frameThicknessInput = document.getElementById('frameThickness');
        const thicknessValueSpan = document.getElementById('thicknessValue');
        const photoSizeScaleInput = document.getElementById('photoSizeScale');
        const sizeValueSpan = document.getElementById('sizeValue');
        const stripWidthInput = document.getElementById('stripWidth');
        const stripHeightInput = document.getElementById('stripHeight');
        
        const imageUpload = document.getElementById('imageUpload');
        const addImageToStripBtn = document.getElementById('addImageToStripBtn');
        const stickerLibrary = document.getElementById('stickerLibrary');
        const customStickerUpload = document.getElementById('customStickerUpload');
        const addCustomStickerBtn = document.getElementById('addCustomStickerBtn');
        
        const designList = document.getElementById('designList');

        // Text Controls
        const textInput = document.getElementById('textInput');
        const fontSelect = document.getElementById('fontSelect');
        const textColorInput = document.getElementById('textColor');
        const fontSizeInput = document.getElementById('fontSize');
        const fontSizeValueSpan = document.getElementById('fontSizeValue');
        const addTextToStripBtn = document.getElementById('addTextToStripBtn');
        const saveDesignBtn = document.getElementById('saveDesignBtn');
        const exportShareLinkBtn = document.getElementById('exportShareLinkBtn');
        
        // Design File Upload
        const designUpload = document.getElementById('designUpload');
        
        // Layer Controls
        const bringForwardBtn = document.getElementById('bringForwardBtn');
        const sendBackwardBtn = document.getElementById('sendBackwardBtn');
        const bringToFrontBtn = document.getElementById('bringToFrontBtn');
        const sendToBackBtn = document.getElementById('sendToBackBtn');
        const layerControlAlert = document.getElementById('layerControlAlert');
        
        // CÁC PHẦN TỬ CHO VIEWER MODE
        const controlsPanel = document.getElementById('controls-panel');
        const designerActionsTop = document.getElementById('designer-actions-top');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const canvasHeader = document.getElementById('canvas-header');
        const viewerImageUpload = document.getElementById('viewerImageUpload');
        const viewerImageUploadLabel = document.getElementById('viewerImageUploadLabel'); // Nút Tải ảnh cho Viewer Mode

        const MAX_PHOTOS = 4;

        let capturedPhotos = []; 
        let currentPhotoIndex = 0;
        let canvasObjects = []; 

        let isDragging = false;
        let isResizing = false;
        let isRotating = false; 
        let selectedObject = null;
        let startX;
        let startY;
        let lastAngle = 0; 
        let currentDesignId = null;

        // Cập nhật trạng thái hiển thị của nút Layer Control
        function updateLayerControls() {
            if (selectedObject) {
                layerControlAlert.style.display = 'none';
                bringForwardBtn.disabled = false;
                sendBackwardBtn.disabled = false;
                bringToFrontBtn.disabled = false;
                sendToBackBtn.disabled = false;
            } else {
                layerControlAlert.style.display = 'block';
                bringForwardBtn.disabled = true;
                sendBackwardBtn.disabled = true;
                bringToFrontBtn.disabled = true;
                sendToBackBtn.disabled = true;
            }
        }


        canvas.addEventListener('contextmenu', (e) => {
            // Chỉ cho phép xóa khi đang ở Designer Mode
            if (controlsPanel.style.display === 'none') return;
            
            e.preventDefault(); 
            if (selectedObject) {
                 if (confirm("Bạn có muốn xóa đối tượng đã chọn này không?")) {
                    canvasObjects = canvasObjects.filter(obj => obj !== selectedObject);
                    selectedObject = null;
                    drawFrame();
                    updateLayerControls();
                 }
            }
        });


        // =======================================================
        // PHẦN 1: KHỞI TẠO VÀ VẼ CANVAS
        // =======================================================

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                webcamFeed.srcObject = stream;
                webcamFeed.style.display = 'block';
                capturePhotoBtn.style.display = 'block';
            } catch (error) {
                console.error("Không thể truy cập webcam:", error);
                // Nếu không ở Viewer Mode, cảnh báo lỗi.
                if (controlsPanel.style.display !== 'none') {
                    alert("Không thể truy cập Webcam. Vui lòng sử dụng tính năng 'Tải Lên Ảnh Cá Nhân/Idol'.");
                }
                webcamFeed.style.display = 'none';
                capturePhotoBtn.style.display = 'none';
            }
        }

        function updateCaptureButtonText() {
            if (currentPhotoIndex < MAX_PHOTOS) {
                capturePhotoBtn.textContent = `Chụp Ảnh (${currentPhotoIndex + 1}/${MAX_PHOTOS})`;
                capturePhotoBtn.disabled = false;
            } else {
                capturePhotoBtn.textContent = `HOÀN TẤT CHỤP! (Sẵn sàng Xuất Ảnh)`;
                capturePhotoBtn.disabled = true;
            }
        }
        
        function capturePhoto() {
            if (currentPhotoIndex >= MAX_PHOTOS) return;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcamFeed.videoWidth;
            tempCanvas.height = webcamFeed.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCtx.drawImage(webcamFeed, 0, 0, tempCanvas.width, tempCanvas.height);

            const capturedImage = new Image();
            capturedImage.onload = () => {
                capturedPhotos[currentPhotoIndex] = {
                    index: currentPhotoIndex,
                    image: capturedImage,
                    src: tempCanvas.toDataURL('image/png') 
                };
                currentPhotoIndex++;
                updateCaptureButtonText();
                drawFrame(); 
            };
            capturedImage.src = tempCanvas.toDataURL('image/png');
        }


        function drawFrame() {
            const scale = parseFloat(photoSizeScaleInput.value);
            const thickness = parseInt(frameThicknessInput.value);
            
            let currentWidth = parseFloat(stripWidthInput.value);
            let currentHeight = parseFloat(stripHeightInput.value);

            currentWidth = Math.max(100, currentWidth);
            currentHeight = Math.max(300, currentHeight);
            stripWidthInput.value = currentWidth.toFixed(0);
            stripHeightInput.value = currentHeight.toFixed(0);

            canvas.width = currentWidth;
            canvas.height = currentHeight;
            thicknessValueSpan.textContent = `${thickness}px`;
            sizeValueSpan.textContent = `${(scale * 100).toFixed(0)}%`;
            fontSizeValueSpan.textContent = `${fontSizeInput.value}px`; 


            ctx.clearRect(0, 0, currentWidth, currentHeight);
            ctx.fillStyle = frameColorInput.value;
            ctx.fillRect(0, 0, currentWidth, currentHeight);

            const photoWidth = currentWidth - 2 * thickness;
            const photoHeight = (currentHeight - (MAX_PHOTOS + 1) * thickness) / MAX_PHOTOS; 

            if (photoWidth <= 0 || photoHeight <= 0) {
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText('Kích thước khung quá lớn!', currentWidth / 2, currentHeight / 2);
                return;
            }

            for (let i = 0; i < MAX_PHOTOS; i++) {
                const x = thickness;
                const y = thickness + i * (photoHeight + thickness); 

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x, y, photoWidth, photoHeight);

                if (capturedPhotos[i] && capturedPhotos[i].image) {
                    const img = capturedPhotos[i].image;
                    const imgW = img.width;
                    const imgH = img.height;
                    
                    const fillRatio = Math.max(photoWidth / imgW, photoHeight / imgH);
                    
                    const finalDrawW = imgW * fillRatio * scale;
                    const finalDrawH = imgH * fillRatio * scale;

                    const drawX = x + (photoWidth - finalDrawW) / 2;
                    const drawY = y + (photoHeight - finalDrawH) / 2;
                    
                    ctx.drawImage(img, drawX, drawY, finalDrawW, finalDrawH);

                } else {
                    ctx.fillStyle = 'gray';
                    ctx.font = '30px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Ảnh ${i + 1} CHƯA CHỤP`, x + photoWidth / 2, y + photoHeight / 2);
                }
            }
            
            // VẼ CÁC STICKER/ẢNH/TEXT Tải lên
            canvasObjects.forEach(obj => {
                ctx.save();
                
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(obj.angle || 0); 
                ctx.translate(-centerX, -centerY); 

                if (obj.type === 'image' || obj.type === 'sticker') {
                    ctx.drawImage(obj.image, obj.x, obj.y, obj.width, obj.height);
                } else if (obj.type === 'text') {
                    // Cập nhật lại width/height dựa trên kích thước text
                    ctx.font = `${obj.fontSize}px "${obj.fontFamily}", sans-serif`;
                    ctx.fillStyle = obj.textColor;
                    ctx.textAlign = 'center'; // Cố định text center để xoay đúng tâm
                    ctx.textBaseline = 'middle'; 

                    const metrics = ctx.measureText(obj.text);
                    obj.width = metrics.width;
                    obj.height = obj.fontSize * 1.2; // Ước lượng chiều cao

                    // Vẽ text (x, y là tâm của bounding box)
                    ctx.fillText(obj.text, obj.x + obj.width / 2, obj.y + obj.height / 2); 
                }
                
                // Vẽ viền và điểm điều khiển chỉ khi ở Designer Mode VÀ đối tượng được chọn
                if (controlsPanel.style.display !== 'none' && obj === selectedObject) {
                    ctx.strokeStyle = '#FF00FF'; 
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                    
                    const controlPointSize = 10;
                    
                    // Nút Resize (dưới phải)
                    ctx.fillStyle = '#00FFFF';
                    ctx.fillRect(obj.x + obj.width - controlPointSize / 2, 
                                 obj.y + obj.height - controlPointSize / 2, 
                                 controlPointSize, controlPointSize);
                    
                    // Nút Rotate (trên trái)
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(obj.x - controlPointSize / 2, 
                                 obj.y - controlPointSize / 2, 
                                 controlPointSize, controlPointSize);
                }
                ctx.restore(); 
            });
        }

        // =======================================================
        // PHẦN 2: LOGIC THÊM ẢNH/STICKER/TEXT
        // =======================================================

        function handleImageAdd(source, name, type, positionData = null) {
            const img = new Image();
            img.onload = () => {
                const defaultSize = 150; 
                let aspectRatio = 1;

                if (img.width > 0 && img.height > 0) {
                    aspectRatio = img.height / img.width;
                }

                let initialWidth = defaultSize;
                if (img.width > canvas.width) {
                    initialWidth = canvas.width / 4;
                    aspectRatio = img.height / img.width;
                }

                const newObject = {
                    name: name,
                    type: type, 
                    image: img,
                    src: source, 
                    x: positionData ? positionData.x : canvas.width / 2 - initialWidth / 2, 
                    y: positionData ? positionData.y : canvas.height / 2 - initialWidth / 2,
                    width: positionData ? positionData.width : initialWidth,
                    height: positionData ? positionData.height : initialWidth * aspectRatio,
                    angle: positionData ? positionData.angle : 0, 
                };
                
                canvasObjects.push(newObject);
                selectedObject = newObject; 
                drawFrame(); 
                updateLayerControls();
            };
            img.onerror = () => {
                console.error(`Không thể tải ${type}: ${name}. Source: ${source}`);
                alert(`Lỗi: Không thể tải ${type} "${name}". Vui lòng kiểm tra file hoặc đường dẫn.`);
            };
            
            if (source.startsWith('http') && !source.startsWith(window.location.origin)) {
                img.crossOrigin = "Anonymous";
            }
            img.src = source;
        }

        function handleTextAdd() {
            const text = textInput.value;
            const font = fontSelect.value;
            const color = textColorInput.value;
            const size = parseInt(fontSizeInput.value);

            if (!text.trim()) {
                alert("Vui lòng nhập văn bản hoặc chữ ký.");
                return;
            }

            const newObject = {
                name: text,
                type: 'text',
                text: text,
                fontFamily: font,
                textColor: color,
                fontSize: size,
                x: canvas.width / 2, 
                y: canvas.height / 2,
                width: 0, 
                height: 0, 
                angle: 0,
                textAlign: 'center', 
                textBaseline: 'middle' 
            };
            canvasObjects.push(newObject);
            selectedObject = newObject; 
            drawFrame(); 
            updateLayerControls();
            textInput.value = '';
        }

        // =======================================================
        // PHẦN 3: LOGIC KÉO, THẢ, RESIZING, ROTATING & LAYER
        // =======================================================

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }
        
        function isPointInObject(x, y, obj) {
            const centerX = obj.x + obj.width / 2;
            const centerY = obj.y + obj.height / 2;

            const cos = Math.cos(-obj.angle);
            const sin = Math.sin(-obj.angle);
            
            const rotatedX = cos * (x - centerX) - sin * (y - centerY) + centerX;
            const rotatedY = sin * (x - centerX) + cos * (y - centerY) + centerY;

            return rotatedX >= obj.x && rotatedX <= obj.x + obj.width &&
                   rotatedY >= obj.y && rotatedY <= obj.y + obj.height;
        }
        
        function checkRotatedHandle(x, y, obj, handleType) {
            const controlPointSize = 10;
            let handleX, handleY;

            if (handleType === 'resize') {
                handleX = obj.x + obj.width - controlPointSize / 2;
                handleY = obj.y + obj.height - controlPointSize / 2;
            } else if (handleType === 'rotate') {
                handleX = obj.x - controlPointSize / 2;
                handleY = obj.y - controlPointSize / 2;
            } else {
                return false;
            }

            const centerX = obj.x + obj.width / 2;
            const centerY = obj.y + obj.height / 2;

            const cos = Math.cos(-obj.angle);
            const sin = Math.sin(-obj.angle);

            const rotatedMouseX = cos * (x - centerX) - sin * (y - centerY) + centerX;
            const rotatedMouseY = sin * (x - centerX) + cos * (y - centerY) + centerY;
            
            return rotatedMouseX >= handleX - 5 && rotatedMouseX <= handleX + controlPointSize + 5 &&
                   rotatedMouseY >= handleY - 5 && rotatedMouseY <= handleY + controlPointSize + 5;
        }

        function isPointInResizeHandle(x, y, obj) {
            return checkRotatedHandle(x, y, obj, 'resize');
        }

        function isPointInRotateHandle(x, y, obj) {
            return checkRotatedHandle(x, y, obj, 'rotate');
        }

        function handleMouseDown(e) {
            if (controlsPanel.style.display === 'none') return;
            
            const mousePos = getMousePos(e);
            let foundObject = null;
            isResizing = false;
            isRotating = false;
            
            if (e.button === 2) return; 
            
            selectedObject = null; 

            for (let i = canvasObjects.length - 1; i >= 0; i--) {
                const obj = canvasObjects[i];
                
                if (isPointInRotateHandle(mousePos.x, mousePos.y, obj)) {
                    selectedObject = obj;
                    isRotating = true;
                    isDragging = true; 
                    startX = mousePos.x;
                    startY = mousePos.y;
                    lastAngle = obj.angle || 0; 
                    drawFrame(); 
                    updateLayerControls();
                    return;
                }

                if (isPointInResizeHandle(mousePos.x, mousePos.y, obj)) {
                    selectedObject = obj;
                    isResizing = true;
                    isDragging = true;
                    startX = mousePos.x;
                    startY = mousePos.y;
                    drawFrame();
                    updateLayerControls();
                    return;
                }

                if (isPointInObject(mousePos.x, mousePos.y, obj)) {
                    canvasObjects.splice(i, 1);
                    canvasObjects.push(obj);
                    foundObject = obj;
                    break;
                }
            }

            if (foundObject) {
                selectedObject = foundObject;
                isDragging = true;
                startX = mousePos.x;
                startY = mousePos.y;
                drawFrame(); 
            }
            
            updateLayerControls(); 
        }

        function handleMouseMove(e) {
            if (controlsPanel.style.display === 'none') return;
            if (!isDragging || !selectedObject) {
                return;
            }

            const mousePos = getMousePos(e);
            const dx = mousePos.x - startX;
            const dy = mousePos.y - startY;
            const obj = selectedObject;

            if (isResizing) {
                let newWidth = obj.width + dx;
                if (newWidth < 20) newWidth = 20; 

                if (obj.type === 'image' || obj.type === 'sticker') {
                    if (obj.image && obj.image.width > 0) {
                        const aspectRatio = obj.image.height / obj.image.width;
                        obj.width = newWidth;
                        obj.height = newWidth * aspectRatio;
                    }
                } else if (obj.type === 'text') {
                    let newSize = obj.fontSize + dy / 2; 
                    if (newSize < 10) newSize = 10;
                    obj.fontSize = newSize; 
                }
                
                startX = mousePos.x;
                startY = mousePos.y;

            } else if (isRotating) {
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                
                const currentAngle = Math.atan2(mousePos.y - centerY, mousePos.x - centerX);
                const startPointAngle = Math.atan2(startY - centerY, startX - centerX);
                
                obj.angle = currentAngle - startPointAngle + lastAngle;
                
            } else {
                // Kéo
                obj.x += dx;
                obj.y += dy;
                
                startX = mousePos.x;
                startY = mousePos.y;
            }

            drawFrame();
        }

        function handleMouseUp() {
            if (controlsPanel.style.display === 'none') return;
            if (isRotating && selectedObject) {
                lastAngle = selectedObject.angle || 0; 
            }
            isDragging = false;
            isResizing = false;
            isRotating = false;
        }

        function adjustLayer(direction) {
            if (!selectedObject) {
                alert("Vui lòng chọn một đối tượng để điều chỉnh lớp.");
                return;
            }

            const currentIndex = canvasObjects.findIndex(obj => obj === selectedObject);
            if (currentIndex === -1) return;

            if (direction === 'up' && currentIndex < canvasObjects.length - 1) {
                [canvasObjects[currentIndex], canvasObjects[currentIndex + 1]] = [canvasObjects[currentIndex + 1], canvasObjects[currentIndex]];
            } else if (direction === 'down' && currentIndex > 0) {
                [canvasObjects[currentIndex], canvasObjects[currentIndex - 1]] = [canvasObjects[currentIndex - 1], canvasObjects[currentIndex]];
            } else if (direction === 'front') {
                canvasObjects.splice(currentIndex, 1);
                canvasObjects.push(selectedObject);
            } else if (direction === 'back') {
                canvasObjects.splice(currentIndex, 1);
                canvasObjects.unshift(selectedObject);
            }

            drawFrame();
        }

        // =======================================================
        // PHẦN 4: LOGIC LƯU/TẢI/XUẤT VÀ CHUYỂN CHẾ ĐỘ
        // =======================================================
        
        function toggleDesignerControls(show) {
            if (show) {
                // DESIGNER MODE: Hiện đầy đủ
                controlsPanel.style.display = 'block';
                designerActionsTop.style.display = 'flex';
                canvasHeader.textContent = "Khung Xem Trước Strip 4 Ảnh (Bấm chuột phải để Xóa đối tượng)";
                mainTitle.textContent = "Tạo Strip Photo Booth Cá Nhân";

                webcamFeed.parentElement.style.display = 'block'; 
                viewerImageUploadLabel.style.display = 'none'; 
                exportFinalImageBtn.style.marginTop = '20px'; 
                
                // Loại bỏ class viewer-active để CSS Control không can thiệp
                document.documentElement.classList.remove('viewer-active');
                
            } else {
                // VIEWER MODE: Ẩn controls
                controlsPanel.style.display = 'none';
                designerActionsTop.style.display = 'none'; 
                canvasHeader.textContent = "Khung Ảnh Strip Photobooth Của Bạn";
                mainTitle.textContent = "Sử Dụng Mẫu Photobooth";

                webcamFeed.parentElement.style.display = 'block'; 
                viewerImageUploadLabel.style.display = 'block'; 
                exportFinalImageBtn.style.marginTop = '5px'; 

                // Giữ nguyên class viewer-active
            }
        }


        function loadDesigns() {
            const savedDesigns = JSON.parse(localStorage.getItem('photoBoothDesigns') || '[]');
            designList.innerHTML = '';
            
            if (savedDesigns.length === 0) {
                 designList.innerHTML = '<p>Chưa có thiết kế nào được lưu. Bấm **+ Tạo Mẫu Thiết Kế Mới** để bắt đầu!</p>';
                 return;
            }
            
            savedDesigns.forEach((design, index) => {
                const card = document.createElement('div');
                card.className = 'design-card';
                card.innerHTML = `
                    <h3>${design.name || `Mẫu Photobooth ${new Date(design.timestamp).toLocaleDateString('vi-VN')}`}</h3>
                    <p>ID: ${design.id}</p>
                    <p>Lưu lúc: ${new Date(design.timestamp).toLocaleTimeString('vi-VN')}</p>
                    <div class="action-group">
                        <button class="load-btn" onclick="loadDesignByIndex(${index})">Tải & Chỉnh Sửa</button>
                        <button class="delete-btn" onclick="deleteDesignByIndex(${index})">Xóa</button>
                    </div>
                `;
                designList.appendChild(card);
            });
        }

        function showLibrary() {
            designView.style.display = 'none';
            libraryView.style.display = 'block'; 
            
            toggleDesignerControls(true); 
            loadDesigns(); 
            
            if (webcamFeed.srcObject) {
                webcamFeed.srcObject.getTracks().forEach(track => track.stop());
                webcamFeed.srcObject = null;
            }
        }


        function showDesign(isNew = false, designData = null) {
            designView.style.display = 'flex';
            libraryView.style.display = 'none';
            currentDesignId = null; 
            selectedObject = null;
            
            capturedPhotos = [];
            currentPhotoIndex = 0;
            canvasObjects = [];
            
            if (isNew) {
                frameColorInput.value = '#000000';
                frameThicknessInput.value = '25';
                photoSizeScaleInput.value = '1.0';
                stripWidthInput.value = '600';
                stripHeightInput.value = '1800';
                currentDesignId = Math.random().toString(36).substring(2, 9);
            }

            if (designData) {
                currentDesignId = designData.id || Math.random().toString(36).substring(2, 9);
                frameColorInput.value = designData.settings.frameColor || '#000000';
                frameThicknessInput.value = designData.settings.frameThickness || '25';
                photoSizeScaleInput.value = designData.settings.photoSizeScale || '1.0';
                stripWidthInput.value = designData.settings.stripWidth || '600';
                stripHeightInput.value = designData.settings.stripHeight || '1800';
                
                
                const photosToLoad = designData.photos || [];
                const objectsToLoad = designData.objects || [];
                
                // Tải Photos
                photosToLoad.forEach((photoData, index) => {
                    if (photoData && photoData.src) {
                        const img = new Image();
                        img.onload = () => {
                            capturedPhotos[index] = { index: index, image: img, src: photoData.src };
                            currentPhotoIndex = Math.max(currentPhotoIndex, index + 1);
                            updateCaptureButtonText();
                            drawFrame();
                        };
                        img.crossOrigin = "Anonymous";
                        img.src = photoData.src;
                    }
                });
                
                // Tải Objects
                let loadCount = 0;
                const totalObjects = objectsToLoad.length;
                
                const finishLoading = () => {
                    loadCount++;
                    if (loadCount === totalObjects || totalObjects === 0) {
                        drawFrame();
                        if (controlsPanel.style.display !== 'none') {
                            alert(`Thiết kế "${designData.name || currentDesignId}" đã được tải thành công!`);
                        }
                    }
                };

                if (totalObjects === 0) { 
                    finishLoading();
                }

                objectsToLoad.forEach(objData => {
                    if (objData.type === 'text') {
                        canvasObjects.push(objData);
                        finishLoading();
                    } else if (objData.src) {
                        const img = new Image();
                        img.onload = () => {
                            canvasObjects.push({...objData, image: img});
                            finishLoading();
                        };
                        img.onerror = finishLoading; 
                        img.crossOrigin = "Anonymous"; 
                        img.src = objData.src;
                    } else {
                        finishLoading(); 
                    }
                });
            }

            drawFrame();
            updateCaptureButtonText();
            updateLayerControls();
            if (!webcamFeed.srcObject || !webcamFeed.srcObject.active) {
                startWebcam();
            }
        }
        
        // Hàm Lưu Thiết Kế & Tải File JSON
        function saveDesign() {
            if (!currentDesignId) {
                currentDesignId = Math.random().toString(36).substring(2, 9);
            }

            const designName = prompt("Nhập tên cho mẫu thiết kế này:", `Mẫu Photobooth ${new Date().toLocaleDateString('vi-VN')}`);
            if (!designName) return;

            const savedDesignData = {
                id: currentDesignId,
                name: designName,
                timestamp: Date.now(),
                settings: {
                    frameColor: frameColorInput.value,
                    frameThickness: frameThicknessInput.value,
                    photoSizeScale: photoSizeScaleInput.value,
                    stripWidth: stripWidthInput.value,
                    stripHeight: stripHeightInput.value,
                },
                photos: capturedPhotos.map(p => (p ? { src: p.src } : null)), 
                objects: canvasObjects.map(obj => {
                    if (obj.type !== 'text') {
                        const { image, ...rest } = obj;
                        return rest;
                    }
                    return obj;
                })
            };

            // 1. Lưu vào Local Storage
            let allDesigns = JSON.parse(localStorage.getItem('photoBoothDesigns') || '[]');
            const existingIndex = allDesigns.findIndex(d => d.id === currentDesignId);

            if (existingIndex > -1) {
                allDesigns[existingIndex] = savedDesignData;
            } else {
                allDesigns.push(savedDesignData);
            }

            localStorage.setItem('photoBoothDesigns', JSON.stringify(allDesigns));
            
            // 2. TẢI XUỐNG FILE JSON
            const jsonString = JSON.stringify(savedDesignData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${designName.replace(/[^a-z0-9]/gi, '_')}.photobooth.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`✅ Thiết kế "${designName}" đã được lưu vào Thư Viện và tải xuống thành file .json! Bạn có thể gửi file này cho người khác.`);
        }
        
        // Hàm xử lý Tải File JSON
        function handleDesignUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const designData = JSON.parse(e.target.result);
                    if (designData && designData.settings) {
                        showDesign(false, designData);
                        toggleDesignerControls(true); 
                    } else {
                        throw new Error("Dữ liệu JSON không hợp lệ.");
                    }
                } catch (error) {
                    alert("❌ Lỗi khi tải file thiết kế. Vui lòng đảm bảo đây là file JSON hợp lệ.");
                    console.error("Lỗi khi đọc file JSON:", error);
                }
            };
            reader.readAsText(file);
        }

        function loadDesignByIndex(index) {
            const savedDesigns = JSON.parse(localStorage.getItem('photoBoothDesigns') || '[]');
            if (savedDesigns[index]) {
                showDesign(false, savedDesigns[index]);
                toggleDesignerControls(true); 
            } else {
                alert("Không tìm thấy thiết kế này.");
            }
        }

        function deleteDesignByIndex(index) {
             if (confirm("Bạn có chắc chắn muốn xóa thiết kế này?")) {
                const savedDesigns = JSON.parse(localStorage.getItem('photoBoothDesigns') || '[]');
                savedDesigns.splice(index, 1); 
                localStorage.setItem('photoBoothDesigns', JSON.stringify(savedDesigns));
                loadDesigns(); 
                alert("Thiết kế đã được xóa.");
            }
        }
        
        function exportFinalImage() {
            drawFrame(); 
            
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `photobooth-strip-${currentDesignId || Date.now()}.png`;
            link.href = imageURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Hàm Xuất Link Chia Sẻ (Base64)
        function exportShareLink() {
            const designDataToShare = {
                id: currentDesignId || Math.random().toString(36).substring(2, 9),
                name: "Thiết Kế Được Chia Sẻ",
                timestamp: Date.now(),
                settings: {
                    frameColor: frameColorInput.value,
                    frameThickness: frameThicknessInput.value,
                    photoSizeScale: photoSizeScaleInput.value,
                    stripWidth: stripWidthInput.value,
                    stripHeight: stripHeightInput.value,
                },
                photos: capturedPhotos.map(p => (p ? { src: p.src } : null)), 
                objects: canvasObjects.map(obj => {
                    if (obj.type !== 'text') {
                        const { image, ...rest } = obj;
                        return rest;
                    }
                    return obj;
                })
            };

            const jsonString = JSON.stringify(designDataToShare);
            const encodedDesign = btoa(unescape(encodeURIComponent(jsonString)));
            const shareLink = `${window.location.href.split('#')[0]}#${encodedDesign}`;
            
            const promptResult = prompt(
                "✅ Link Chia Sẻ Thiết Kế (Đã nhúng toàn bộ dữ liệu).\nVui lòng BÔI ĐEN toàn bộ link và nhấn Ctrl+C (hoặc Cmd+C) để sao chép:", 
                shareLink
            );

            if (promptResult === null) {
                alert("Bạn đã hủy thao tác sao chép link.");
            }
        }
        
        // =======================================================
        // PHẦN 5: GẮN SỰ KIỆN VÀ KHỞI TẠO
        // =======================================================

        // Gắn sự kiện Tải Ảnh (Designer Mode)
        addImageToStripBtn.addEventListener('click', () => {
            const file = imageUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    handleImageAdd(e.target.result, file.name, 'image');
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một file ảnh để tải lên.");
            }
        });
        
        // Gắn sự kiện Tải Mẫu Thiết Kế (JSON)
        designUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleDesignUpload(file);
            }
        });


        // Gắn sự kiện Tải Sticker Tùy Chỉnh
        addCustomStickerBtn.addEventListener('click', () => {
            const file = customStickerUpload.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    handleImageAdd(e.target.result, file.name, 'sticker');
                };
                reader.readAsDataURL(file);
            } else {
                alert("Vui lòng chọn một file sticker để tải lên.");
            }
        });
        
        // Gắn sự kiện Tải Sticker Có Sẵn
        stickerLibrary.querySelectorAll('.predefined-sticker').forEach(button => {
            button.addEventListener('click', (e) => {
                const url = e.currentTarget.getAttribute('data-sticker-url');
                const name = e.currentTarget.textContent.trim();
                handleImageAdd(url, name, 'sticker');
            });
        });
        
        // Gắn sự kiện Thêm Text
        addTextToStripBtn.addEventListener('click', handleTextAdd);

        // Gắn sự kiện Chụp ảnh
        capturePhotoBtn.addEventListener('click', capturePhoto);

        // Gắn sự kiện Lưu/Xuất
        saveDesignBtn.addEventListener('click', saveDesign);
        exportFinalImageBtn.addEventListener('click', exportFinalImage);
        exportShareLinkBtn.addEventListener('click', exportShareLink);
        
        // Gắn sự kiện Điều chỉnh Lớp
        bringForwardBtn.addEventListener('click', () => adjustLayer('up'));
        sendBackwardBtn.addEventListener('click', () => adjustLayer('down'));
        bringToFrontBtn.addEventListener('click', () => adjustLayer('front'));
        sendToBackBtn.addEventListener('click', () => adjustLayer('back'));

        // Gắn sự kiện Tải ảnh cho Viewer Mode (MỚI)
        viewerImageUpload.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const slotIndex = capturedPhotos.findIndex(p => p === null || p === undefined);
                        const indexToUse = slotIndex !== -1 ? slotIndex : 0;
                        
                        capturedPhotos[indexToUse] = {
                            index: indexToUse,
                            image: img,
                            src: e.target.result
                        };
                        
                        if (currentPhotoIndex <= indexToUse) {
                            currentPhotoIndex = indexToUse + 1;
                        }
                        
                        updateCaptureButtonText();
                        drawFrame();
                        alert(`Ảnh đã được tải lên slot ${indexToUse + 1}.`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });


        // Gắn sự kiện cho các điều khiển
        frameColorInput.addEventListener('input', drawFrame);
        frameThicknessInput.addEventListener('input', drawFrame);
        photoSizeScaleInput.addEventListener('input', drawFrame);
        stripWidthInput.addEventListener('change', drawFrame);
        stripHeightInput.addEventListener('change', drawFrame);
        fontSizeInput.addEventListener('input', () => {
             fontSizeValueSpan.textContent = `${fontSizeInput.value}px`;
             drawFrame(); 
        });
        fontSelect.addEventListener('change', drawFrame); 
        
        // Gắn sự kiện Kéo/Thả/Resize/Rotate
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mouseout', handleMouseUp); 


        // LOGIC TẢI THIẾT KẾ TỪ BASE64/URL HASH (FIX TRIỆT ĐỂ LỖI QUAY VỀ TRANG CHỦ)
        window.onload = () => {
            const hashValue = window.location.hash.substring(1);
            
            // 1. Nếu KHÔNG có hash, tải thư viện và KẾT THÚC
            if (!hashValue) {
                showLibrary();
                return;
            }

            // 2. Nếu CÓ hash, BỎ QUA showLibrary() và CHỈ xử lý Viewer Mode
            try {
                const decodedJsonString = decodeURIComponent(escape(atob(hashValue)));
                const designData = JSON.parse(decodedJsonString);
                
                if (designData && designData.settings) {
                    showDesign(false, designData);
                    toggleDesignerControls(false); 
                } else {
                    // Dữ liệu hash hợp lệ nhưng JSON hỏng (ví dụ: thiếu settings)
                    throw new Error("Dữ liệu thiết kế bị hỏng. Vui lòng tạo link mới.");
                }

            } catch (e) {
                // Xử lý LỖI TẢI: Hiển thị một khung ảnh trống với thông báo lỗi
                console.error("LỖI TẢI THIẾT KẾ CHIA SẺ:", e);
                
                // Hiển thị khung ảnh trống (Viewer Mode)
                showDesign(false, { 
                    settings: { frameColor: '#000000', frameThickness: '25', photoSizeScale: '1.0', stripWidth: '600', stripHeight: '1800' }, 
                    photos: [], 
                    objects: [] 
                });
                toggleDesignerControls(false); 

                alert(`❌ Lỗi tải mẫu thiết kế chia sẻ: ${e.message || 'Lỗi không xác định'}. Vui lòng yêu cầu người gửi tạo lại link mới.`);
            }
        };
    </script>
</body>
</html>