<script>
        // --- KHAI BÁO BIẾN CHO VIEWER MODE ---
        const canvas = document.getElementById('photoStripCanvas');
        const ctx = canvas.getContext('2d');
        const webcamFeed = document.getElementById('webcamFeed');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const exportFinalImageBtn = document.getElementById('exportFinalImageBtn');
        const viewerImageUpload = document.getElementById('viewerImageUpload');

        const MAX_PHOTOS = 4;
        let capturedPhotos = []; 
        let currentPhotoIndex = 0;
        let canvasObjects = []; 
        let currentDesignId = null;

        let frameColor = '#000000';
        let frameThickness = 25;
        let photoSizeScale = 1.0;
        let stripWidth = 600;
        let stripHeight = 1800;

        // =======================================================
        // CÁC HÀM CƠ BẢN (START WEBCAM, DRAW FRAME, CAPTURE PHOTO, EXPORT)
        // =======================================================

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                webcamFeed.srcObject = stream;
                webcamFeed.style.display = 'block';
                capturePhotoBtn.style.display = 'block';
            } catch (error) {
                console.error("Không thể truy cập webcam:", error);
                webcamFeed.style.display = 'none';
                capturePhotoBtn.style.display = 'none';
            }
        }
        
        function updateCaptureButtonText() {
            if (currentPhotoIndex < MAX_PHOTOS) {
                capturePhotoBtn.textContent = `Chụp Ảnh (${currentPhotoIndex + 1}/${MAX_PHOTOS})`;
                capturePhotoBtn.disabled = false;
            } else {
                capturePhotoBtn.textContent = `HOÀN TẤT CHỤP! (Sẵn sàng Xuất Ảnh)`;
                capturePhotoBtn.disabled = true;
            }
        }

        function capturePhoto() {
            if (currentPhotoIndex >= MAX_PHOTOS) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcamFeed.videoWidth;
            tempCanvas.height = webcamFeed.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(webcamFeed, 0, 0, tempCanvas.width, tempCanvas.height);
            const capturedImage = new Image();
            capturedImage.onload = () => {
                capturedPhotos[currentPhotoIndex] = { index: currentPhotoIndex, image: capturedImage, src: tempCanvas.toDataURL('image/png') };
                currentPhotoIndex++;
                updateCaptureButtonText();
                drawFrame(); 
            };
            capturedImage.src = tempCanvas.toDataURL('image/png');
        }

        function drawFrame() {
            // Cập nhật lại kích thước canvas
            canvas.width = stripWidth;
            canvas.height = stripHeight;

            const photoWidth = stripWidth - 2 * frameThickness;
            const photoHeight = (stripHeight - (MAX_PHOTOS + 1) * frameThickness) / MAX_PHOTOS; 

            ctx.clearRect(0, 0, stripWidth, stripHeight);
            ctx.fillStyle = frameColor;
            ctx.fillRect(0, 0, stripWidth, stripHeight);

            for (let i = 0; i < MAX_PHOTOS; i++) {
                const x = frameThickness;
                const y = frameThickness + i * (photoHeight + frameThickness); 

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x, y, photoWidth, photoHeight);

                if (capturedPhotos[i] && capturedPhotos[i].image) {
                    const img = capturedPhotos[i].image;
                    const fillRatio = Math.max(photoWidth / img.width, photoHeight / img.height);
                    const finalDrawW = img.width * fillRatio * photoSizeScale;
                    const finalDrawH = img.height * fillRatio * photoSizeScale;
                    const drawX = x + (photoWidth - finalDrawW) / 2;
                    const drawY = y + (photoHeight - finalDrawH) / 2;
                    ctx.drawImage(img, drawX, drawY, finalDrawW, finalDrawH);
                } else {
                    ctx.fillStyle = 'gray';
                    ctx.font = '30px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Ảnh ${i + 1} CHƯA CHỤP`, x + photoWidth / 2, y + photoHeight / 2);
                }
            }
            
            // VẼ CÁC STICKER/TEXT 
            canvasObjects.forEach(obj => {
                ctx.save();
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(obj.angle || 0); 
                ctx.translate(-centerX, -centerY); 

                if (obj.type === 'image' || obj.type === 'sticker') {
                    ctx.drawImage(obj.image, obj.x, obj.y, obj.width, obj.height);
                } else if (obj.type === 'text') {
                    ctx.font = `${obj.fontSize}px "${obj.fontFamily}", sans-serif`;
                    ctx.fillStyle = obj.textColor;
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle'; 
                    ctx.fillText(obj.text, obj.x + obj.width / 2, obj.y + obj.height / 2); 
                }
                ctx.restore(); 
            });
        }

        function exportFinalImage() {
            drawFrame(); 
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `photobooth-strip-${currentDesignId || Date.now()}.png`;
            link.href = imageURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =======================================================
        // LOGIC TẢI DỮ LIỆU CHIA SẺ
        // =======================================================

        function loadDesignFromData(designData) {
            // 1. Cập nhật Settings
            frameColor = designData.settings.frameColor || '#000000';
            frameThickness = parseInt(designData.settings.frameThickness) || 25;
            photoSizeScale = parseFloat(designData.settings.photoSizeScale) || 1.0;
            stripWidth = parseInt(designData.settings.stripWidth) || 600;
            stripHeight = parseInt(designData.settings.stripHeight) || 1800;
            currentDesignId = designData.id;
            
            // FIX: GỌI DRAW FRAME NGAY LẬP TỨC ĐỂ CANVAS HIỂN THỊ
            drawFrame(); 

            // 2. Tải Objects (Sticker/Text)
            canvasObjects = [];
            let loadCount = 0;
            const objectsToLoad = designData.objects || [];
            const totalObjects = objectsToLoad.length;
            
            const finishLoading = () => {
                loadCount++;
                if (loadCount === totalObjects || totalObjects === 0) {
                    drawFrame(); // Vẽ lại sau khi tất cả objects/text đã được tải
                }
            };

            if (totalObjects === 0) finishLoading();

            objectsToLoad.forEach(objData => {
                if (objData.type === 'text') {
                    canvasObjects.push(objData);
                    finishLoading();
                } else if (objData.src) {
                    const img = new Image();
                    img.onload = () => {
                        canvasObjects.push({...objData, image: img});
                        finishLoading();
                    };
                    img.onerror = finishLoading; 
                    img.crossOrigin = "Anonymous"; 
                    img.src = objData.src;
                } else {
                    finishLoading(); 
                }
            });
            
            // 3. Khởi tạo Webcam và Buttons
            startWebcam();
            updateCaptureButtonText();
        }

        // =======================================================
        // KHỞI TẠO
        // =======================================================

        window.onload = () => {
            const hashValue = window.location.hash.substring(1);
            const container = document.getElementById('viewer-container');
            
            if (!hashValue) {
                container.innerHTML = `
                    <div class="alert-message">
                        **LỖI:** Không tìm thấy dữ liệu mẫu thiết kế chia sẻ. Vui lòng kiểm tra lại đường link.
                    </div>
                    <a href="index.html" class="primary-action" style="text-decoration: none;">
                        ← Quay lại Trang Thiết Kế (index.html)
                    </a>
                `;
                return;
            }

            try {
                const decodedJsonString = decodeURIComponent(escape(atob(hashValue)));
                const designData = JSON.parse(decodedJsonString);
                
                if (designData && designData.settings) {
                    loadDesignFromData(designData);
                } else {
                    throw new Error("Dữ liệu thiết kế không hợp lệ hoặc trống.");
                }

            } catch (e) {
                console.error("LỖI TẢI THIẾT KẾ CHIA SẺ:", e);
                container.innerHTML = `
                    <div class="alert-message">
                        **LỖI:** Mẫu thiết kế không thể tải được. Dữ liệu bị hỏng hoặc chưa được lưu đúng cách.
                        <p>${e.message || 'Lỗi không xác định'}</p>
                    </div>
                    <a href="index.html" class="primary-action" style="text-decoration: none;">
                        ← Quay lại Trang Thiết Kế (index.html)
                    </a>
                `;
            }
        };

        // Gắn sự kiện 
        capturePhotoBtn.addEventListener('click', capturePhoto);
        exportFinalImageBtn.addEventListener('click', exportFinalImage);
        
        viewerImageUpload.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const slotIndex = capturedPhotos.findIndex(p => p === null || p === undefined);
                        const indexToUse = slotIndex !== -1 ? slotIndex : 0;
                        capturedPhotos[indexToUse] = { index: indexToUse, image: img, src: e.target.result };
                        if (currentPhotoIndex <= indexToUse) currentPhotoIndex = indexToUse + 1;
                        updateCaptureButtonText();
                        drawFrame();
                        alert(`Ảnh đã được tải lên slot ${indexToUse + 1}.`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>