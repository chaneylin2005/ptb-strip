<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Booth Strip Viewer</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Montserrat:ital,wght@0,400;0,700;1,400&family=Pacifico&family=Pinyon+Script&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== CSS CƠ BẢN ==================== */
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        header { background-color: #007bff; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        button, .primary-action, .secondary-action { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; width: 100%; margin-top: 5px; }
        .primary-action { background-color: #28a745; color: white; font-size: 1.1em; margin-top: 20px; }
        .primary-action:hover { background-color: #1e7e34; }
        .secondary-action { background-color: #6c757d; color: white; }
        .secondary-action:hover { background-color: #5a6268; }
        .alert-message { background-color: #fff3cd; color: #856404; padding: 10px; border: 1px solid #ffeeba; border-radius: 4px; margin-bottom: 20px; text-align: center; }

        /* ==================== VIEW GỌN NHẸ ==================== */
        #viewer-container { max-width: 650px; margin: 20px auto; padding: 0 15px; text-align: center; }
        #photoStripCanvas { border: 5px dashed #ccc; background-color: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); max-width: 100%; height: auto; display: block; margin: 20px auto; }
        .webcam-preview { margin-top: 20px; }
        #webcamFeed { width: 300px; height: auto; border: 2px solid #333; display: block; margin: 10px auto; }
        #viewerImageUploadLabel { text-align: center; margin-bottom: 5px; background-color: #17a2b8; color: white; display: block; }
        
    </style>
</head>
<body>

    <header>
        <h1 id="main-title">Sử Dụng Mẫu Photobooth</h1>
    </header>

    <div id="viewer-container">
        <h2 id="canvas-header">Khung Ảnh Strip Photobooth Của Bạn</h2>
        <canvas id="photoStripCanvas" width="600" height="1800">
            Trình duyệt của bạn không hỗ trợ Canvas.
        </canvas>
        <div class="webcam-preview">
            <video id="webcamFeed" autoplay></video>
            <button id="capturePhotoBtn" class="primary-action" style="background-color: #ffc107; color: #333; width: 100%; margin-top: 0;">Chụp Ảnh (1/4)</button>
            
            <label for="viewerImageUpload" id="viewerImageUploadLabel" class="secondary-action" style="margin-top: 5px;">
                **Hoặc Tải Ảnh Lên Để Thay Thế**
            </label>
            <input type="file" id="viewerImageUpload" accept="image/*" style="display: none;">
        </div>
        
        <button id="exportFinalImageBtn" class="primary-action">Xuất Strip Ảnh Hoàn Chỉnh (Tải về)</button>
        
        <div class="alert-message" style="margin-top: 20px;">
             Bạn không thể chỉnh sửa thiết kế này. Để tạo mẫu riêng, hãy truy cập trang chủ.
        </div>
        
        <a id="backToDesignLink" href="index.html" class="secondary-action" style="display: block; margin-top: 15px; text-decoration: none;">
            ← Quay lại Trang Thiết Kế (index.html)
        </a>
    </div>

    <footer>
        <p>&copy; 2025 Photo Booth Designer Của Bạn</p>
    </footer>

    <script>
        // --- HÀM HỖ TRỢ URL-SAFE BASE64 (ĐẶT Ở ĐÂY ĐỂ ĐẢM BẢO PHẠM VI TOÀN CỤC) ---
        function urlSafeBase64Decode(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            // Thêm padding cho atob()
            while (str.length % 4) {
                str += '=';
            }
            return str;
        }
        // ------------------------------------------

        // --- KHAI BÁO BIẾN CHO VIEWER MODE ---
        const canvas = document.getElementById('photoStripCanvas');
        const ctx = canvas.getContext('2d');
        const webcamFeed = document.getElementById('webcamFeed');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const exportFinalImageBtn = document.getElementById('exportFinalImageBtn');
        const viewerImageUpload = document.getElementById('viewerImageUpload');

        const MAX_PHOTOS = 4;
        let capturedPhotos = []; 
        let currentPhotoIndex = 0;
        let canvasObjects = []; 
        let currentDesignId = null;

        // Giá trị mặc định an toàn cho việc vẽ
        let frameColor = '#000000';
        let frameThickness = 25;
        let photoSizeScale = 1.0;
        let stripWidth = 600;
        let stripHeight = 1800;
        
        

        // =======================================================
        // CÁC HÀM CƠ BẢN (START WEBCAM, DRAW FRAME, CAPTURE PHOTO, EXPORT)
        // =======================================================

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                webcamFeed.srcObject = stream;
                webcamFeed.style.display = 'block';
                capturePhotoBtn.style.display = 'block';
            } catch (error) {
                console.error("Không thể truy cập webcam:", error);
                webcamFeed.style.display = 'none';
                capturePhotoBtn.style.display = 'none';
            }
        }
        
        function updateCaptureButtonText() {
            if (currentPhotoIndex < MAX_PHOTOS) {
                capturePhotoBtn.textContent = `Chụp Ảnh (${currentPhotoIndex + 1}/${MAX_PHOTOS})`;
                capturePhotoBtn.disabled = false;
            } else {
                capturePhotoBtn.textContent = `HOÀN TẤT CHỤP! (Sẵn sàng Xuất Ảnh)`;
                capturePhotoBtn.disabled = true;
            }
        }

        function capturePhoto() {
            if (currentPhotoIndex >= MAX_PHOTOS) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = webcamFeed.videoWidth;
            tempCanvas.height = webcamFeed.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(webcamFeed, 0, 0, tempCanvas.width, tempCtx.height);
            const capturedImage = new Image();
            capturedImage.onload = () => {
                capturedPhotos[currentPhotoIndex] = { index: currentPhotoIndex, image: capturedImage, src: tempCanvas.toDataURL('image/png') };
                currentPhotoIndex++;
                updateCaptureButtonText();
                drawFrame(); 
            };
            capturedImage.src = tempCanvas.toDataURL('image/png');
        }

        function drawFrame() {
            // Cập nhật lại kích thước canvas
            canvas.width = stripWidth;
            canvas.height = stripHeight;

            const photoWidth = stripWidth - 2 * frameThickness;
            const photoHeight = (stripHeight - (MAX_PHOTOS + 1) * frameThickness) / MAX_PHOTOS; 

            ctx.clearRect(0, 0, stripWidth, stripHeight);
            ctx.fillStyle = frameColor;
            ctx.fillRect(0, 0, stripWidth, stripHeight); // Tô nền (thường là đen)

            if (photoWidth <= 0 || photoHeight <= 0) {
                 // Nếu kích thước khung ảnh lỗi, hiển thị thông báo thay vì màn hình đen
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.font = '30px sans-serif';
                ctx.fillText('LỖI KÍCH THƯỚC KHUNG!', stripWidth / 2, stripHeight / 2);
                return;
            }
            
            for (let i = 0; i < MAX_PHOTOS; i++) {
                const x = frameThickness;
                const y = frameThickness + i * (photoHeight + frameThickness); 

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x, y, photoWidth, photoHeight); // Vẽ khung ảnh trắng

                if (capturedPhotos[i] && capturedPhotos[i].image) {
                    const img = capturedPhotos[i].image;
                    const fillRatio = Math.max(photoWidth / img.width, photoHeight / img.height);
                    const finalDrawW = img.width * fillRatio * photoSizeScale;
                    const finalDrawH = img.height * fillRatio * photoSizeScale;
                    const drawX = x + (photoWidth - finalDrawW) / 2;
                    const drawY = y + (photoHeight - finalDrawH) / 2;
                    ctx.drawImage(img, drawX, drawY, finalDrawW, finalDrawH);
                } else {
                    ctx.fillStyle = 'gray';
                    ctx.font = '30px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Ảnh ${i + 1} CHƯA CHỤP`, x + photoWidth / 2, y + photoHeight / 2);
                }
            }
            
            // VẼ CÁC STICKER/TEXT 
            canvasObjects.forEach(obj => {
                ctx.save();
                const centerX = obj.x + obj.width / 2;
                const centerY = obj.y + obj.height / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(obj.angle || 0); 
                ctx.translate(-centerX, -centerY); 

                if (obj.type === 'image' || obj.type === 'sticker') {
                    ctx.drawImage(obj.image, obj.x, obj.y, obj.width, obj.height);
                } else if (obj.type === 'text') {
                    ctx.font = `${obj.fontSize}px "${obj.fontFamily}", sans-serif`;
                    ctx.fillStyle = obj.textColor;
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle'; 
                    ctx.fillText(obj.text, obj.x + obj.width / 2, obj.y + obj.height / 2); 
                }
                ctx.restore(); 
            });
        }

        function exportFinalImage() {
            drawFrame(); 
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `photobooth-strip-${currentDesignId || Date.now()}.png`;
            link.href = imageURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =======================================================
        // LOGIC TẢI DỮ LIỆU CHIA SẺ
        // =======================================================

        function loadDesignFromData(designData) {
            // 1. Cập nhật Settings
            frameColor = designData.settings.frameColor || '#000000';
            frameThickness = parseInt(designData.settings.frameThickness) || 25;
            photoSizeScale = parseFloat(designData.settings.photoSizeScale) || 1.0;
            stripWidth = parseInt(designData.settings.stripWidth) || 600;
            stripHeight = parseInt(designData.settings.stripHeight) || 1800;
            currentDesignId = designData.id;
            
            // RẤT QUAN TRỌNG: GỌI DRAW FRAME NGAY LẬP TỨC
            drawFrame(); 

            // 2. Tải Objects (Sticker/Text)
            canvasObjects = [];
            let loadCount = 0;
            const objectsToLoad = designData.objects || [];
            const totalObjects = objectsToLoad.length;
            
            const finishLoading = () => {
                loadCount++;
                if (loadCount === totalObjects || totalObjects === 0) {
                    drawFrame(); // Vẽ lại sau khi tất cả objects/text đã được tải
                }
            };

            if (totalObjects === 0) finishLoading();

            objectsToLoad.forEach(objData => {
                if (objData.type === 'text') {
                    canvasObjects.push(objData);
                    finishLoading();
                } else if (objData.src) {
                    const img = new Image();
                    img.onload = () => {
                        canvasObjects.push({...objData, image: img});
                        finishLoading();
                    };
                    img.onerror = finishLoading; 
                    img.crossOrigin = "Anonymous"; 
                    img.src = objData.src;
                } else {
                    finishLoading(); 
                }
            });
            
            // 3. Khởi tạo Webcam và Buttons
            startWebcam();
            updateCaptureButtonText();
        }

        // =======================================================
        // KHỞI TẠO
        // =======================================================

        window.onload = () => {
            const hashValue = window.location.hash.substring(1);
            const container = document.getElementById('viewer-container');
            
            if (!hashValue) {
                container.innerHTML = `
                    <div class="alert-message">
                        **LỖI:** Không tìm thấy dữ liệu mẫu thiết kế chia sẻ. Vui lòng kiểm tra lại đường link.
                    </div>
                    <a href="index.html" class="primary-action" style="text-decoration: none;">
                        ← Quay lại Trang Thiết Kế (index.html)
                    </a>
                `;
                return;
            }

            try {
                // SỬ DỤNG HÀM URL-SAFE DECODE ĐỂ KHẮC PHỤC LỖI ATOM
                const safeHashValue = urlSafeBase64Decode(hashValue);
                const decodedJsonString = decodeURIComponent(escape(atob(safeHashValue)));
                const designData = JSON.parse(decodedJsonString);
                
                if (designData && designData.settings) {
                    loadDesignFromData(designData);
                } else {
                    throw new Error("Dữ liệu thiết kế không hợp lệ hoặc trống.");
                }

            } catch (e) {
                console.error("LỖI TẢI THIẾT KẾ CHIA SẺ:", e);
                container.innerHTML = `
                    <div class="alert-message">
                        **LỖI:** Mẫu thiết kế không thể tải được. Dữ liệu bị hỏng hoặc chưa được lưu đúng cách.
                        <p>Chi tiết lỗi: ${e.message}</p>
                    </div>
                    <a href="index.html" class="primary-action" style="text-decoration: none;">
                        ← Quay lại Trang Thiết Kế (index.html)
                    </a>
                `;
            }
        };

        // Gắn sự kiện 
        capturePhotoBtn.addEventListener('click', capturePhoto);
        exportFinalImageBtn.addEventListener('click', exportFinalImage);
        
        viewerImageUpload.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const slotIndex = capturedPhotos.findIndex(p => p === null || p === undefined);
                        const indexToUse = slotIndex !== -1 ? slotIndex : 0;
                        capturedPhotos[indexToUse] = { index: indexToUse, image: img, src: e.target.result };
                        if (currentPhotoIndex <= indexToUse) currentPhotoIndex = indexToUse + 1;
                        updateCaptureButtonText();
                        drawFrame();
                        alert(`Ảnh đã được tải lên slot ${indexToUse + 1}.`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>